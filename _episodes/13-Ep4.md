---
title: "Collaborating and Data Anlysis Using HydroShare Workflows"
teaching: 20
exercises: 2
topics:
- "Introduction to Groups in HydroShare"
- "Joining the HI-DSI HydroShare Group"
- "Performing Data Anlysis Using a Scientific Workflow"

objectives:
- "To allow the audience some experience using a science gateways and existing workflows in a collaborative environment"

keypoints:
- "Scienctific gateways like HydroShare, enable researchers to form and join groups and communities, within the gateway, with similar research interests."
- "Existing workflows can be discovered and used to aid researchers perform visualization and analysis on their data, eliminating the need to write all the necessary foundational codes."
---

    # Only run this cell if the libraries are not already installed
    !pip install rasterio
    !pip install geopandas
    !pip install hstools
  
  
  
    import os
    import rasterio as rio
    %matplotlib inline
    from matplotlib import pyplot as plt
    from matplotlib import colors



    ! pwd



    ! ls



    # Define convenience plotting function
    cmap='terrain'
    label='Elevation (m)'
    import math
    import numpy as np
    def rp(raster,cmap='terrain',label='',bounds=[]):
        with rio.open(raster) as src:
            boundary = src.bounds
            parray = src.read()
            nodata = src.nodata
            parray=np.where(parray == nodata,math.nan,parray)

        # Plot the imported data
        plt.figure(figsize=(20,10))
        # if using bounds
        if(len(bounds) > 0):
            bounds=np.insert(bounds,0,np.nanmin(parray))
            bounds=np.append(bounds,np.nanmax(parray))
            norm = colors.BoundaryNorm(bounds, cmap.N)
            imgplot = plt.imshow(parray[0],cmap=cmap,norm=norm)
        else:
            imgplot = plt.imshow(parray[0],cmap=cmap)
        cbar = plt.colorbar()
        cbar.set_label(label)
        # plt.savefig('LoganDEM.png', dpi=450, bbox_inches = 'tight')   # activate this command if you want to save the figure. Note that it should be called before plt.show()
        plt.show()



    # display the raw dem
    dem = 'logan.tif'
    rp(dem,label="Elevation (m)",)
    

{% include figure.html url="" max-width="50%"
   file="/fig/loganraw.png"
   alt="Connect to cluster" caption="" %}



    !mpiexec -n 4 pitremove {dem} 



    ! ls  # This lists the files present.  
    # Note you should see the additional output file loganfel.tif that was written by the previous command.

    loganfel.tif	  logan.tif   Outlet_meta.xml	 Outlet.shp
    logan_meta.xml	  logan.vrt   Outlet.prj	 Outlet.shx
    logan_resmap.xml  Outlet.dbf  Outlet_resmap.xml  TauDEM.ipynb



    !mpiexec -n 4 d8flowdir -p loganp.tif -sd8 logansd8.tif -fel loganfel.tif  



    rp('loganp.tif',plt.get_cmap('gist_earth', 8),'D8 Flow Direction')
    rp('logansd8.tif','terrain','D8 Slope')
    
    
{% include figure.html url="" max-width="50%"
   file="/fig/code5.png"
   alt="Connect to cluster" caption="" %}
   
{% include figure.html url="" max-width="50%"
   file="/fig/code6.png"
   alt="Connect to cluster" caption="" %}
   

    !mpiexec -n 4 aread8 -p loganp.tif -o Outlet.shp -ad8 loganad8o.tif
    !mpiexec -n 8 peukerdouglas -fel loganfel.tif -ss loganss.tif -par 0.4 0.1 0.05
    !mpiexec -n 8 aread8 -p loganp.tif -ad8 loganssa.tif -wg loganss.tif -o Outlet.shp
    !mpiexec -n 8 dropanalysis -fel loganfel.tif -p loganp.tif -ad8 loganad8o.tif -ssa loganssa.tif -o Outlet.shp -drp logandrp.txt -par 10   1000 15 0

    # Determine threshold from last line of drp.txt file after colon.
    with open("logandrp.txt", 'r') as f:
        lines = f.read().splitlines()
    thresh=lines[len(lines)-1].split(":")[1]
    print("\nOptimal stream definition threshold:"+thresh)
    
    
  
  
    rp('loganad8o.tif',colors.ListedColormap(['white', 'lightskyblue', 'cyan', 'blue', 'navy']),'D8 Contributing area',bounds=[300,1000,3000,10000])   

{% include figure.html url="" max-width="50%"
   file="/fig/code9.png"
   alt="Connect to cluster" caption="" %}
   
   
## Stream Network Analysis using TauDEM functions

    !mpiexec -n 4 threshold -ssa loganssa.tif -src logansrc.tif -thresh {thresh}
    !mpiexec -n 4 streamnet -fel loganfel.tif -p loganp.tif -ad8 loganad8o.tif -src logansrc.tif -ord loganord3.tif -tree logantree.dat -coord logancoord.dat -net logannet.shp -w loganw.tif -o Outlet.shp
 
 
 
 
    rp('loganw.tif')    
    
{% include figure.html url="" max-width="50%"
   file="/fig/code12.png"
   alt="Connect to cluster" caption="" %}
 
 
    !ls
    loganad8o.tif	logannet.shp	  loganssa.tif	 Outlet_meta.xml
    logancoord.dat	logannet.shx	  loganss.tif	 Outlet.prj
    logandrp.txt	loganord3.tif	  logan.tif	 Outlet_resmap.xml
    loganfel.tif	loganp.tif	  logantree.dat  Outlet.shp
    logan_meta.xml	logan_resmap.xml  logan.vrt	 Outlet.shx
    logannet.dbf	logansd8.tif	  loganw.tif	 TauDEM.ipynb
    logannet.prj	logansrc.tif	  Outlet.dbf
    
    
    
    
    from geopandas import GeoSeries, GeoDataFrame, read_file, gpd    
    
    
    
    
    streamnet = read_file('logannet.shp')
    streamnet
    
    
    
    
    plt.figure(figsize=(30, 24))
    streamnet.plot()
    
    
{% include figure.html url="" max-width="50%"
   file="/fig/code16.png"
   alt="Connect to cluster" caption="" %}

Congratulations! You have successfully delineated subwatershed and a stream network using TauDEM. If you want to retain your work you could at this point save the contents of your folder back to HydroShare, or download them.

## Save the Results back into HydroShare

We'll be using the hstools library to save our data back to HydroShare. Run the following commands to learn more about how to use this tool.

    !hs --help
    
    usage: hs {get, add, create, delete, list, describe, init} [-h, --help]

    HSTools is a humble collection of tools for interacting with data in the
    HydroShare repository. It wraps the HydroShare REST API to provide simple
    commands for working with resources.

    positional arguments:
      {get,add,create,delete,list,describe,init}
        get                 Retrieve resource content from HydroShare
        add                 Add files to an existing HydroShare resource
        create              Create a new HydroShare resource
        delete              Delete a HydroShare resource
        list                List HydroShare resources that you own
        describe            Describe metadata and files
        init                Initialize a connection with HydroShare

    optional arguments:
      -h, --help            show this help message and exit
      




    !hs create --help
    usage: hs create  [-q] [-v] [-f] [-k] [-t] [-a] [-h]

    Create a new HydroShare resource

    optional arguments:
      -h, --help            show this help message and exit
      -a ABSTRACT [ABSTRACT ...], --abstract ABSTRACT [ABSTRACT ...]
                        resource description
      -t TITLE [TITLE ...], --title TITLE [TITLE ...]
                        resource title
      -k KEYWORDS [KEYWORDS ...], --keywords KEYWORDS [KEYWORDS ...]
                        space separated list of keywords
      -f FILES [FILES ...], --files FILES [FILES ...]
                        space separated list of files
      -v                    verbose output
      -q                    suppress output
  



    !ls
    loganad8o.tif	logannet.shp	  loganssa.tif	 Outlet_meta.xml
    logancoord.dat	logannet.shx	  loganss.tif	 Outlet.prj
    logandrp.txt	loganord3.tif	  logan.tif	 Outlet_resmap.xml
    loganfel.tif	loganp.tif	  logantree.dat  Outlet.shp
    logan_meta.xml	logan_resmap.xml  logan.vrt	 Outlet.shx
    logannet.dbf	logansd8.tif	  loganw.tif	 TauDEM.ipynb
    logannet.prj	logansrc.tif	  Outlet.dbf





    # define metadata variables
   
    keywords = ['TauDEM', 'Logan River']
    abstract = "Jupyter Notebook TauDEM was used to define streamflow and subwatersheds in the Logan River Watershed in Utah."

    title = "Test TauDEM Result" 
    files = !find . -maxdepth 1 -type f     # shows all the files created
    print(files)

    # Select the files that you want to save
    files = ['./logan.tif', './TauDEM.ipynb', 
            'Outlet.shp','Outlet.prj',
            'Outlet.shx','Outlet.dbf'
    ]
  





    # Initialize HydroShare connection
    # This is an awkward way to initialize the HydroShare connection from inside Jupyter.  An alternative is to open
    # a terminal and run hs init
    import hstools as hs
    import os
    import sys
    import json
    import base64
    import argparse
    from getpass import getpass
    from hstools import hydroshare
    def init(loc='.'):
        fp = os.path.abspath(os.path.join(loc, '.hs_auth'))
        if os.path.exists(fp):
            print(f'Auth already exists: {fp}')
            remove = input('Do you want to replace it [Y/n]')
            if remove.lower() == 'n':
                sys.exit(0)
            os.remove(fp)

        usr = input('Enter HydroShare Username: ')
        pwd = getpass('Enter HydroShare Password: ')

        dat = {'usr': usr,
              'pwd': pwd}
        cred_json_string = str.encode(json.dumps(dat))
        cred_encoded = base64.b64encode(cred_json_string)
        with open(fp, 'w') as f:
            f.write(cred_encoded.decode('utf-8'))

        try:
            hydroshare.hydroshare(authfile=fp)
        except Exception:
            print('Authentication Failed')
            os.remove(fp)
            sys.exit(1)

        print(f'Auth saved to: {fp}')
    init('/home/jovyan')
    




    !hs create -t {title} -a {abstract} -k {' '.join(keywords)} -f {' '.join(files)}
    + creating resource
    + adding: ./logan.tif
    + adding: ./TauDEM.ipynb
    + adding: Outlet.shp
    + adding: Outlet.prj
    + adding: Outlet.shx
    + adding: Outlet.dbf
